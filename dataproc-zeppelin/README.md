# Настройка хранения ноутбуков Zeppelin в бакете Object Storage на кластерах Yandex Data Proc

В кластерах [Yandex Data Proc](https://cloud.yandex.ru/services/data-proc) поддерживается работа с ноутбуками [Apache Zeppelin](https://zeppelin.apache.org/). Для обеспечения сохранности создаваемых ноутбуков, особенно в условиях применения временных кластеров Data Proc, рекомендуется организовать хранение ноутбуков в бакете Yandex Object Storage. Хранение ноутбуков в S3-совместимых хранилищах (к которым относится и Yandex Object Storage) обеспечивается специальным плагином, поставляемым в составе Apache Zeppelin.

Общий порядок настройки плагина для хранения ноутбуков в S3 приведен в [документации на Zeppelin](https://zeppelin.apache.org/docs/0.10.1/setup/storage/storage.html#notebook-storage-in-s3). Требуется выполнить следующий набор действий:

1. Создать отдельный бакет Object Storage для хранения ноутбуков.
2. Создать сервисную учетную запись для доступа к бакету, и разрешить ей чтение и запись на уровне этого бакета.
3. Создать ключ сервисной учетной записи для аутентификации при обращении к Object Storage.
4. (опционально) Включить версионирование бакета Object Storage, что обеспечит возможность доступа к предыдущим версиям ноутбуков и к удаленным ноутбукам в случае такой необходимости.
5. Установить свойства `zeppelin.notebook.storage` и `zeppelin.notebook.s3.bucket` в файле `zeppelin-site.xml` (обычно выполняется через свойства кластера Data Proc).
6. Добавить в файл переменных окружения `zeppelin-env.sh` созданный на шаге (3) ключ для доступа к S3 бакету с ноутбуками.

[Создание бакета](https://yandex.cloud/ru/docs/storage/operations/buckets/create) и [настройка версионирования](https://yandex.cloud/ru/docs/storage/operations/buckets/versioning) могут быть выполнены через Консоль Yandex Cloud.

В репозитории приведен [пример скрипта](./make_sa.sh) для выполнения операций по созданию сервисной учетной записи, настройке прав доступа к бакету, созданию ключа доступа и помещению ключа в секрет [Yandex Lockbox](https://yandex.cloud/ru/services/lockbox) для обеспечения защищенного доступа к нему при создании кластера.

Установка ключа доступа к Object Storage в переменные окружения Zeppelin может быть автоматизирована с помощью скрипта инициализации. Предлагаемый [пример в репозитории](./init_zeppelin.sh) читает ключ из секрета Lockbox, а затем добавляет его в файл `zeppelin-env.sh`. При необходимости выполняется рестарт сервиса Zeppelin для применения изменений.

Также в репозитории представлен [пример скрипта для создания кластера](./dp-zeppelin-s3.sh) Data Proc, в котором установлены необходимые настройки для хранения ноутбуков Zeppelin в Object Storage.
