# Раскраска динамических вычислительных ресурсов Data Proc метками проектов

При создании множества кластеров [Yandex Data Proc](https://cloud.yandex.ru/services/data-proc) в рамках одного облака и одной папки иногда возникает необходимость отнесения затрат на эти кластера к разным бизнес-проектам.

Информация о затратах с посуточной детализацией доступна из файлов экспорта в формате CSV, которые могут формироваться средствами биллинга Yandex Cloud и сохраняться в объектном хранилище в соответствии с заданными настройками. Каждый кластер Data Proc отражается в данных биллинга в виде набора строк, соответствующих выделенным для работы кластера виртуальных серверов, а также наценке на вычислительные ресурсы за использование управляемого сервиса Data Proc.

Дополнить информацию биллинга по-проектными метками отнесения затрат можно с помощью запроса над данными биллинга, который можно выполнить с помощью сервиса [Yandex Query](https://cloud.yandex.ru/services/query), который может работать непосредственно с сохраняемыми биллингом CSV-файлами, а при необходимости - с любыми подготовленными пользователем справочниками. Для отображения подготовленных данных в максимально удобном виде можно задействовать сервис [DataLens](https://cloud.yandex.ru/services/datalens).

## Организация разметки данных биллинга Data Proc проектными метками

Привязка идентификаторов проектов к кластерам Data Proc может поставляться в виде внешнего справочника, который должен содержать следующие поля:
* дата действия привязки;
* идентификатор кластера Data Proc;
* идентификатор проекта.

Привязка кластеров Data Proc к проектам могут опционально устанавливаться непосредственно средствами Yandex Cloud в виде пользовательской метки на ресурс соответствующего кластера Data Proc, как показано в примере ниже:

```bash
yc dataproc cluster add-labels --name <Кластер> --labels project_id=<МеткаПроекта>
```

В приведённой выше команде:
* <Кластер> - логическое имя кластера Data Proc;
* <МеткаПроекта> - идентификатор, используемый для ссылки на бизнес-проект.

Пользовательские метки доступны в данных биллинга в виде дополнительных колонок формата `label.user_labels.<ИмяМетки>`.

Вычислительные ресурсы кластеров Data Proc (в первую очередь, создаваемые сервисом Data Proc виртуальные машины) необходимо сопоставить с конкретным кластером Data Proc. Для этого можно использовать метку `cluster_id`, которую сервис Data Proc автоматически устанавливает на создаваемые мастер-узлы и статические вычислительные узлы. К сожалению, эта метка пока не устанавливается автоматически на узлы, созданные в результате работы механизма автоскейлинга Data Proc. Это ограничение можно преодолеть с помощью [бессерверной функции](https://cloud.yandex.ru/services/functions), которая размещена в этом репозитории.

## Бессервеная функция для маркировки узлов Data Proc



## Пример запроса к данным биллинга

Пример запроса Yandex Query над данными биллинга для разметки позиций затрат кластеров Data Proc метками проектов:

```SQL
SELECT
    COALESCE(y.project_id, '-') AS project_id,
    x.`cloud_name`,
    x.`folder_name`,
    x.`resource_id`,
    x.`service_name`,
    x.`sku_name`,
    x.`date`,
    x.`currency`,
    x.`pricing_quantity`,
    x.`pricing_unit`,
    x.`cost`,
    x.`credit`,
    x.`monetary_grant_credit`,
    x.`volume_incentive_credit`,
    x.`cud_credit`,
    x.`misc_credit`,
FROM bindings.`billing-billing1_billing1-detail/` AS x
LEFT JOIN (
SELECT DISTINCT
    `date`,
    `label.user_labels.cluster_id` AS cluster_id,
    `label.user_labels.project_id` AS project_id
FROM bindings.`billing-billing1_billing1-detail/`
WHERE `label.user_labels.cluster_id` IS NOT NULL
  AND `label.user_labels.cluster_id`<>''
  AND `label.user_labels.project_id` IS NOT NULL
  AND `label.user_labels.project_id`<>''
  AND `date`>=Date('2022-10-01')
  AND `date`<Date('2022-11-01')
) AS y
ON y.cluster_id = x.`label.user_labels.cluster_id` AND y.`date`=x.`date`
WHERE x.`date`>=Date('2022-10-01')
  AND x.`date`<Date('2022-11-01')
;
```
