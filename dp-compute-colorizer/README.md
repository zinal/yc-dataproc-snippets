# Раскраска динамических вычислительных ресурсов Data Proc метками проектов

При создании множества кластеров [Yandex Data Proc](https://cloud.yandex.ru/services/data-proc) в рамках одной папки Yandex Cloud иногда возникает необходимость отнесения затрат на эти кластера к разным бизнес-проектам.

Информация о затратах на сервисы Yandex Cloud с посуточной детализацией доступна из файлов экспорта в формате CSV, которые могут формироваться средствами биллинга Yandex Cloud и сохраняться в объектном хранилище в соответствии с заданными настройками, как описано в [документации биллинга](https://cloud.yandex.ru/docs/billing/operations/get-folder-report). Каждый кластер Data Proc отражается в данных биллинга в виде набора строк, соответствующих выделенным для работы кластера виртуальных серверов и дисков, а также наценке на вычислительные ресурсы за использование управляемого сервиса Data Proc.

Обработка выгруженных в формате CSV данных биллинга может осуществляться с помощью SQL-запросов, выполняемых в среде [сервиса Yandex Query](https://cloud.yandex.ru/docs/query/tutorials/billing), а затем отображаться с помощью [отчетов DataLens](https://cloud.yandex.ru/docs/query/tutorials/datalens).

Для получения по-проектной детализации необходимо сопоставить записи выгрузки со справочником бизнес-проектов, используя следующую цепочку связей: ресурс (виртуальная машина или диск) -> кластер Data Proc -> бизнес-проект. На сегодня (по состоянию на ноябрь 2022 года) данные биллинга не содержат сведений о соответствии динамически создаваемых виртуальных машин или дисков и конкретных кластеров Data Proc. Такую связь пользователи Yandex Cloud могут построить самостоятельно в виде отдельного справочника, автоматически формируемого с помощью бессерверных функций (Cloud Functions), как показано в этом примере.

Сохранив справочник соответствия кластеров Data Proc и принадлежащих им ресурсов на каждые сутки в виде файла в объектном хранилище, средствами Yandex Query можно объединить информацию биллинга с этим дополнительным справочником, и получить в отчётах информацию о затратах на сервис Data Proc в разрезе кластеров. Принадлежность кластеров Data Proc бизнес-проектам можем быть установлена на уровне меток объектов кластеров Data Proc, либо в виде отдельного дополнительного справочника, управляемого пользователями.

Общая схема решения приведена на рисунке ниже. Стрелки показывают направление информационных потоков.

![Схема решения](images/solution-schema.png)

## Организация разметки данных биллинга Data Proc проектными метками

Привязка идентификаторов проектов к кластерам Data Proc может поставляться в виде внешнего справочника, который должен содержать следующие поля:
* дата действия привязки;
* идентификатор кластера Data Proc;
* идентификатор проекта.

Привязка кластеров Data Proc к проектам могут опционально устанавливаться непосредственно средствами Yandex Cloud в виде пользовательской метки на ресурс соответствующего кластера Data Proc, как показано в примере ниже:

```bash
yc dataproc cluster add-labels --name <Кластер> --labels project_id=<МеткаПроекта>
```

В приведённой выше команде:
* <Кластер> - логическое имя кластера Data Proc;
* <МеткаПроекта> - идентификатор, используемый для ссылки на бизнес-проект.

Пользовательские метки доступны в данных биллинга в виде дополнительных колонок формата `label.user_labels.<ИмяМетки>`.

Вычислительные ресурсы кластеров Data Proc (в первую очередь, создаваемые сервисом Data Proc виртуальные машины) необходимо сопоставить с конкретным кластером Data Proc. Для этого можно использовать метку `cluster_id`, которую сервис Data Proc автоматически устанавливает на создаваемые мастер-узлы и статические вычислительные узлы. К сожалению, эта метка пока не устанавливается автоматически на динамические узлы кластера, созданные в результате работы механизма автоскейлинга Data Proc. Это ограничение можно преодолеть с помощью [бессерверной функции](https://cloud.yandex.ru/services/functions), которая размещена в этом репозитории.

## Бессервеная функция для маркировки динамических узлов Data Proc

Временное решение для маркировки динамических узлов Data Proc меткой, содержащей идентификатор кластера Data Proc, предлагаемое на период до реализации в сервисе Data Proc аналогичной встроенной функции.

Предлагаемая бессерверная функция выполняет следующие действия:
1. в текущем каталоге (folder) Yandex Cloud находит все кластера Data Proc;
2. для каждого кластера находит все его динамические узлы;
3. для каждого динамического узла проверяет наличие метки `cluster_id`, связывающей его с кластером Data Proc;
4. при отсутствии метки - устанавливает её на соответствующий узел.

Бессерверную функцию рекомендуется поставить на расписание (выполнение по таймеру 1 раз в минуту), что обеспечит автоматическую привязку меток ко всем создаваемым Data Proc динамическим узлам.

Для работы бессерверной функции необходим сервисный аккаунт со следующими полномочиями на уровне папки (folder):
* `viewer` (для просмотра ресурсов);
* `compute.admin` (для установки меток на вычислительные узлы);
* `serverless.functions.invoker` (для запуска функции по таймеру).

[Код бессерверной функции](https://github.com/zinal/yc-dataproc-snippets/blob/main/dp-compute-colorizer/cf/cfunc.py).

Создание необходимых объектов Yandex Cloud приведено в скрипте [install.sh](https://github.com/zinal/yc-dataproc-snippets/blob/main/dp-compute-colorizer/install.sh). Для удаления бессерверной функции подготовлен скрипт [cleanup.sh](https://github.com/zinal/yc-dataproc-snippets/blob/main/dp-compute-colorizer/cleanup.sh)

## Пример запроса к данным биллинга

Пример запроса Yandex Query над данными биллинга для разметки позиций затрат кластеров Data Proc метками проектов:

```SQL
SELECT
    COALESCE(y.project_id, '-') AS project_id,
    x.`cloud_name`,
    x.`folder_name`,
    x.`resource_id`,
    x.`service_name`,
    x.`sku_name`,
    x.`date`,
    x.`currency`,
    x.`pricing_quantity`,
    x.`pricing_unit`,
    x.`cost`,
    x.`credit`,
    x.`monetary_grant_credit`,
    x.`volume_incentive_credit`,
    x.`cud_credit`,
    x.`misc_credit`,
FROM bindings.`billing-billing1_billing1-detail/` AS x
LEFT JOIN (
SELECT DISTINCT
    `date`,
    `label.user_labels.cluster_id` AS cluster_id,
    `label.user_labels.project_id` AS project_id
FROM bindings.`billing-billing1_billing1-detail/`
WHERE `label.user_labels.cluster_id` IS NOT NULL
  AND `label.user_labels.cluster_id`<>''
  AND `label.user_labels.project_id` IS NOT NULL
  AND `label.user_labels.project_id`<>''
  AND `date`>=Date('2022-10-01')
  AND `date`<Date('2022-11-01')
) AS y
ON y.cluster_id = x.`label.user_labels.cluster_id` AND y.`date`=x.`date`
WHERE x.`date`>=Date('2022-10-01')
  AND x.`date`<Date('2022-11-01')
;
```
